<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="assets/logo.png" />
  <meta name="theme-color" content="#2563eb" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>TRANSGULF - Orders</title>
  <style>
    body { background: #fbf2f4; }
    .tile-shadow { box-shadow: 0 10px 22px rgba(15, 23, 42, 0.10); }
  </style>
</head>

<body class="min-h-screen">
  <div id="toast" class="hidden"></div>
  <div id="tgShell">
    <div id="tgPage">
<main class="px-4 md:px-8 pb-24 md:pb-10 pt-4 md:pt-8 w-full">
        <div class="flex items-start justify-between gap-4 mb-5">
          <div>
            <div class="text-xl md:text-2xl font-extrabold text-slate-800">Orders</div>
            <div class="text-sm text-slate-500 font-semibold">Browse orders by status (New / Approved / Rescheduled / Rejected / All).</div>
          </div>
          <a href="new-order.html" class="hidden sm:inline-flex h-11 px-4 rounded-2xl bg-blue-600 text-white tile-shadow font-extrabold items-center">
            âž• New Order
          </a>
        </div>

        <!-- Tabs + Filters -->
        <div class="bg-white rounded-3xl border border-slate-200 tile-shadow p-2 sm:p-3">
          <div class="flex gap-2 overflow-x-auto">
            <button data-tab="new" class="tabBtn px-4 h-10 rounded-2xl font-extrabold text-sm">New</button>
            <button data-tab="approved" class="tabBtn px-4 h-10 rounded-2xl font-extrabold text-sm">Approved</button>
            <button data-tab="rescheduled" class="tabBtn px-4 h-10 rounded-2xl font-extrabold text-sm">Rescheduled</button>
            <button data-tab="rejected" class="tabBtn px-4 h-10 rounded-2xl font-extrabold text-sm">Rejected</button>
            <button data-tab="all" class="tabBtn px-4 h-10 rounded-2xl font-extrabold text-sm">All</button>
          </div>

          <div class="p-3 sm:p-4">
            <div class="flex flex-col gap-3">
              <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
                <div class="flex-1">
                  <input id="txtSearch" type="text" placeholder="Search any field..."
                         class="w-full h-11 rounded-2xl border border-slate-200 bg-slate-50 px-4 text-sm font-semibold focus:outline-none focus:ring-4 focus:ring-blue-500/15 focus:border-blue-500" />
                </div>
                <button id="btnRefresh" class="h-11 px-4 rounded-2xl bg-white border border-slate-200 font-extrabold text-slate-700">Refresh</button>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label class="block text-[11px] font-extrabold text-slate-600 mb-1 uppercase tracking-wider">From date</label>
                  <input id="fromDate" type="date" autocomplete="off"
                         class="w-full h-11 rounded-2xl border border-slate-200 bg-slate-50 px-4 text-sm font-semibold focus:outline-none focus:ring-4 focus:ring-blue-500/15 focus:border-blue-500" />
                </div>
                <div>
                  <label class="block text-[11px] font-extrabold text-slate-600 mb-1 uppercase tracking-wider">To date</label>
                  <input id="toDate" type="date" autocomplete="off"
                         class="w-full h-11 rounded-2xl border border-slate-200 bg-slate-50 px-4 text-sm font-semibold focus:outline-none focus:ring-4 focus:ring-blue-500/15 focus:border-blue-500" />
                </div>
              </div>
            </div>

            <div class="mt-6 w-full overflow-x-auto rounded-2xl border border-slate-200">
              <table class="w-full text-sm bg-white whitespace-nowrap">
                <thead id="ordersThead" class="bg-slate-50 text-slate-600"></thead>
                <tbody id="ordersTbody"></tbody>
              </table>
            </div>

            <div class="mt-4 flex flex-col sm:flex-row sm:items-center gap-3">
              <div class="flex items-center gap-2">
                <button id="btnPrev" class="h-10 px-4 rounded-2xl bg-white border border-slate-200 font-extrabold text-slate-700">Prev</button>
                <button id="btnNext" class="h-10 px-4 rounded-2xl bg-white border border-slate-200 font-extrabold text-slate-700">Next</button>
              </div>
              <div id="pageInfo" class="text-xs text-slate-500 font-bold">Page 1</div>
              <div class="sm:ml-auto flex items-center gap-2">
                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider">Page size</div>
                <select id="pageSize" class="h-10 rounded-2xl border border-slate-200 bg-white px-3 text-sm font-semibold">
                  <option value="10">10</option>
                  <option value="20">20</option>
                  <option value="50">50</option>
                </select>
              </div>
            </div>

            <div id="errBox" class="hidden mt-4 rounded-2xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800"></div>
          </div>
        </div>
      </main>
    </div>
  </div>
  <script src="app.js"></script>
  <script>
    TGApp.initShell('orders');

    let ALL_ROWS = [];
    let ACTIVE = 'new';
    let PAGE_NO = 1;
    let PAGE_SIZE = 10;
    let HAS_MORE = true;
    let TOTAL_COUNT = null;

    const tabs = {
      new: 'New',
      approved: 'Approved',
      rescheduled: 'Rescheduled',
      rejected: 'Rejected',
      all: 'All'
    };

    const STATUS_LABELS = {
      0: 'New',
      1: 'Approved',
      2: 'Rescheduled',
      3: 'Rejected'
    };

    function showError(msg){
      const b=$('errBox');
      b.textContent=msg;
      b.classList.remove('hidden');
    }
    function hideError(){
      const b=$('errBox');
      b.textContent='';
      b.classList.add('hidden');
    }

    function formatDate(val){
      if(!val) return '-';
      if(typeof val === 'string'){
        if(val.includes('T')) return val.split('T')[0];
        return val;
      }
      const d = new Date(val);
      if(Number.isNaN(d.getTime())) return String(val);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function formatQueryDate(val){
      if(!val) return '';
      const d = new Date(val);
      if(Number.isNaN(d.getTime())) return '';
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const dd = String(d.getDate()).padStart(2,'0');
      const mmm = months[d.getMonth()];
      const yyyy = d.getFullYear();
      return `${dd}-${mmm}-${yyyy}`;
    }

    function statusNameFrom(row){
      const statusName = row.STATUSNAME ?? row.statusName;
      if(statusName) return statusName;
      const code = row.STATUS ?? row.status ?? row.statusCode ?? row.Status;
      if(code == null) return 'New';
      const num = Number(code);
      if(!Number.isNaN(num)) return STATUS_LABELS[num] || String(code);
      if(typeof code === 'string' && code.trim()) return code;
      return 'New';
    }

    function buildColumns(rows){
      const cols = [];
      const seen = new Set();
      (rows || []).forEach(row => {
        if(!row || typeof row !== 'object') return;
        Object.keys(row).forEach(key => {
          if(seen.has(key)) return;
          seen.add(key);
          cols.push(key);
        });
      });
      return cols;
    }

    function rowValuesText(row){
      if(!row || typeof row !== 'object') return '';
      return Object.values(row)
        .map(v => (v == null ? '' : String(v)))
        .join(' ')
        .toLowerCase();
    }

    function cellValue(val){
      if(val == null || val === '') return '-';
      if(val instanceof Date) return formatDate(val);
      if(typeof val === 'string' && val.includes('T')) return formatDate(val);
      return String(val);
    }

    function rowHTML(row, cols){
      const cells = cols.map(key => {
        const v = cellValue(row?.[key]);
        return `<td class="p-2 text-slate-600 font-semibold">${v}</td>`;
      }).join('');
      return `<tr class="border-t hover:bg-slate-50">${cells}</tr>`;
    }

    function applyTabsUI(){
      document.querySelectorAll('.tabBtn').forEach(btn => {
        const key = btn.getAttribute('data-tab');
        const isOn = key === ACTIVE;
        btn.className = 'tabBtn px-4 h-10 rounded-2xl font-extrabold text-sm ' +
          (isOn ? 'bg-blue-600 text-white tile-shadow' : 'bg-slate-50 text-slate-700 border border-slate-200');
      });
    }

    function filtered(){
      const q = ($('txtSearch').value || '').trim().toLowerCase();
      const wanted = tabs[ACTIVE];
      return (ALL_ROWS || []).filter(row => {
        const matchTab = (ACTIVE === 'all') ? true : ((statusNameFrom(row) || '') === wanted);
        if(!matchTab) return false;
        if(!q) return true;
        return rowValuesText(row).includes(q);
      });
    }

    function render(){
      applyTabsUI();
      const list = filtered();
      const cols = buildColumns(ALL_ROWS.length ? ALL_ROWS : list);
      $('ordersThead').innerHTML = cols.length ? `
        <tr class="text-left">
          ${cols.map(c => `<th class="p-2 font-extrabold">${c}</th>`).join('')}
        </tr>
      ` : '';
      $('ordersTbody').innerHTML = list.length
        ? list.map(row => rowHTML(row, cols)).join('')
        : `
          <tr class="border-t">
            <td class="p-6 text-center text-slate-600 font-semibold" colspan="${Math.max(cols.length, 1)}">
              No orders found
            </td>
          </tr>
        `;
    }

    function getCusCode(){
      return localStorage.getItem('custtomercode')
        || localStorage.getItem('customerCode')
        || localStorage.getItem('cusCode')
        || '';
    }

    function extractRows(data){
      if(Array.isArray(data)) return data;
      if(!data) return [];
      if(Array.isArray(data.data)) return data.data;
      if(Array.isArray(data.items)) return data.items;
      if(Array.isArray(data.rows)) return data.rows;
      if(Array.isArray(data.orders)) return data.orders;
      return [];
    }

    function extractTotal(data){
      if(!data || Array.isArray(data)) return null;
      const keys = ['total','Total','totalCount','TotalCount','TOTAL','TotalRecords'];
      for(const k of keys){
        if(data[k] != null && !Number.isNaN(Number(data[k]))) return Number(data[k]);
      }
      return null;
    }

    function setPagerUI(){
      const info = $('pageInfo');
      const prev = $('btnPrev');
      const next = $('btnNext');
      const totalText = (TOTAL_COUNT != null) ? ` of ${Math.max(1, Math.ceil(TOTAL_COUNT / PAGE_SIZE))}` : '';
      if(info) info.textContent = `Page ${PAGE_NO}${totalText}`;
      if(prev) prev.disabled = PAGE_NO <= 1;
      if(next) next.disabled = !HAS_MORE;
    }

    function buildQuery(){
      const params = new URLSearchParams();
      const ucode = localStorage.getItem('userCode') || '';
      params.set('UCODE', ucode);
      const reqNo = ($('txtSearch').value || '').trim();
      if(reqNo) params.set('ReqNo', reqNo);
      const cusCode = getCusCode();
      if(cusCode) params.set('CusCode', cusCode);
      if(ACTIVE !== 'all'){
        const statusMap = { new: 0, approved: 1, rescheduled: 2, rejected: 3 };
        if(statusMap[ACTIVE] != null) params.set('Status', String(statusMap[ACTIVE]));
      }
      const fromDate = formatQueryDate($('fromDate')?.value || '');
      if(fromDate) params.set('FromDate', fromDate);
      const toDate = formatQueryDate($('toDate')?.value || '');
      if(toDate) params.set('ToDate', toDate);
      const sortField = null;
      const sortOrder = null;
      if(sortField != null) params.set('SortField', String(sortField));
      if(sortOrder != null) params.set('SortOrder', String(sortOrder));
      params.set('PageNo', String(PAGE_NO));
      params.set('PageSize', String(PAGE_SIZE));
      return params.toString();
    }

    async function load(){
      hideError();
      const qs = buildQuery();
      const data = await TGApp.apiGet(`/GetRequest?${qs}`);
      if(!data){ showError('Unable to load orders'); return; }

      const rows = extractRows(data);
      TOTAL_COUNT = extractTotal(data);
      ALL_ROWS = rows;
      HAS_MORE = TOTAL_COUNT != null ? (PAGE_NO * PAGE_SIZE) < TOTAL_COUNT : rows.length === PAGE_SIZE;
      setPagerUI();
      render();
    }

    $('btnRefresh').addEventListener('click', () => { PAGE_NO = 1; load(); });
    $('txtSearch').addEventListener('input', () => {
      PAGE_NO = 1;
      clearTimeout(window.__searchT);
      window.__searchT = setTimeout(load, 350);
    });
    $('fromDate').addEventListener('change', () => {
      PAGE_NO = 1;
      load();
    });
    $('toDate').addEventListener('change', () => {
      PAGE_NO = 1;
      load();
    });
    $('btnPrev').addEventListener('click', () => {
      if(PAGE_NO > 1){ PAGE_NO -= 1; load(); }
    });
    $('btnNext').addEventListener('click', () => {
      if(HAS_MORE){ PAGE_NO += 1; load(); }
    });
    $('pageSize').addEventListener('change', (e) => {
      PAGE_SIZE = Number(e.target.value || 10);
      PAGE_NO = 1;
      load();
    });

    document.querySelectorAll('.tabBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        ACTIVE = btn.getAttribute('data-tab');
        PAGE_NO = 1;
        load();
      });
    });

    // Read query param tab
    (function(){
      const params = new URLSearchParams(location.search);
      const tab = (params.get('tab') || '').toLowerCase();
      if(tab === 'current') ACTIVE = 'new';
      else if(tabs[tab]) ACTIVE = tab;
    })();

    window.viewOrder = (no) => TGApp.toast('View: ' + no + ' (hook your details page)', 'info');
    window.trackOrder = (no) => TGApp.toast('Track: ' + no + ' (hook GPS tracking)', 'info');

    $('pageSize').value = String(PAGE_SIZE);
    setPagerUI();
    load();
  </script>
</body>
</html>


